{* ≈†ifrov√°n√≠ star√Ωch dat - konzistentn√≠ design *}
{block title}≈†ifrov√°n√≠ star√Ωch dat{/block}

{block content}

{* Hlaviƒçka str√°nky *}
<div class="security-page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>üîí ≈†ifrov√°n√≠ star√Ωch dat</h1>
            <p>Migrace neza≈°ifrovan√Ωch dat na AES-256-GCM ≈°ifrov√°n√≠</p>
        </div>
        <div class="security-header-actions">
            <a href="{link default}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Zpƒõt na p≈ôehled
            </a>
        </div>
    </div>
</div>

{* Stav migrace *}
<div id="migrationStatus" class="mb-4">
    <div class="row">
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="card security-stat-card">
                <div class="card-body">
                    <div class="security-stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="security-stat-number" id="clientsToEncrypt">-</div>
                    <div class="security-stat-label">Klienti k ≈°ifrov√°n√≠</div>
                    <div class="security-stat-subtitle">Neza≈°ifrovan√° data</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="card security-stat-card">
                <div class="card-body">
                    <div class="security-stat-icon">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="security-stat-number" id="companiesToEncrypt">-</div>
                    <div class="security-stat-label">Firemn√≠ √∫daje</div>
                    <div class="security-stat-subtitle">K ≈°ifrov√°n√≠</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="card security-stat-card">
                <div class="card-body">
                    <div class="security-stat-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="security-stat-number" id="encryptionStatus">Analyzuje se...</div>
                    <div class="security-stat-label">Stav ≈°ifrov√°n√≠</div>
                    <div class="security-stat-subtitle">Aktu√°ln√≠ status</div>
                </div>
            </div>
        </div>
    </div>
</div>

{* Anal√Ωza dat - √∫vodn√≠ stav *}
<div id="dataAnalysis" class="security-audit-intro">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card security-intro-card">
                <div class="card-body">
                    <div class="security-intro-icon">
                        <i class="bi bi-search"></i>
                    </div>
                    <h3 class="security-intro-title">Anal√Ωza dat pro ≈°ifrov√°n√≠</h3>
                    <p class="security-intro-description">
                        Syst√©m analyzuje datab√°zi a identifikuje neza≈°ifrovan√° citliv√° data, 
                        kter√° je t≈ôeba migrovat na bezpeƒçn√© AES-256-GCM ≈°ifrov√°n√≠.
                    </p>
                    
                    <div class="row security-intro-features">
                        <div class="col-md-6">
                            <div class="security-feature-section">
                                <h6 class="security-feature-title">
                                    <i class="bi bi-check-circle me-2"></i>Co bude ≈°ifrov√°no:
                                </h6>
                                <ul class="security-feature-list">
                                    <li>E-mailov√© adresy klient≈Ø</li>
                                    <li>Telefonn√≠ ƒç√≠sla</li>
                                    <li>Adresy a Iƒå klient≈Ø</li>
                                    <li>Firemn√≠ kontaktn√≠ √∫daje</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="security-feature-section">
                                <h6 class="security-feature-title">
                                    <i class="bi bi-shield-check me-2"></i>Bezpeƒçnostn√≠ funkce:
                                </h6>
                                <ul class="security-feature-list">
                                    <li>AES-256-GCM ≈°ifrov√°n√≠</li>
                                    <li>Batch processing po 10 z√°znamech</li>
                                    <li>Atomick√© datab√°zov√© transakce</li>
                                    <li>Kompletn√≠ auditn√≠ z√°znam</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button id="analyzeDataBtn" class="btn security-tool-btn btn-primary me-3" data-url="{link analyzeData!}">
                            <i class="bi bi-search me-2"></i>Spustit anal√Ωzu
                        </button>
                        <button id="startEncryptionBtn" class="btn btn-success" style="display: none;" data-url="{link startEncryption!}">
                            <i class="bi bi-lock-fill me-2"></i>Zah√°jit ≈°ifrov√°n√≠
                        </button>
                    </div>
                    
                    <div class="security-intro-warning mt-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Upozornƒõn√≠:</strong> Proces ≈°ifrov√°n√≠ nelze vr√°tit zpƒõt. Ujistƒõte se, ≈æe m√°te z√°lohu datab√°ze.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{* Progress sekce - skryt√° na zaƒç√°tku *}
<div id="encryptionProgress" class="security-tools-section" style="display: none;">
    <h2 class="security-tools-title">Pr≈Øbƒõh ≈°ifrov√°n√≠</h2>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h5 id="progressTitle">≈†ifrov√°n√≠ dat...</h5>
                        <p id="progressDescription" class="text-muted">Zpracov√°v√°m z√°znamy v bezpeƒçn√Ωch batch operac√≠ch</p>
                    </div>
                    
                    {* Progress bar *}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Celkov√Ω pr≈Øbƒõh:</span>
                            <span id="progressPercentage" class="fw-bold">0%</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, #B1D235 0%, #95B11F 100%);"></div>
                        </div>
                    </div>
                    
                    {* Detailn√≠ statistiky *}
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="border rounded p-3">
                                <div class="h5 mb-1" id="processedCount">0</div>
                                <small class="text-muted">Zpracov√°no</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="border rounded p-3">
                                <div class="h5 mb-1" id="totalCount">0</div>
                                <small class="text-muted">Celkem</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="border rounded p-3">
                                <div class="h5 mb-1" id="currentBatch">0</div>
                                <small class="text-muted">Aktu√°ln√≠ batch</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="border rounded p-3">
                                <div class="h5 mb-1" id="errorsCount">0</div>
                                <small class="text-muted">Chyby</small>
                            </div>
                        </div>
                    </div>
                    
                    {* Aktu√°ln√≠ operace *}
                    <div class="mt-4">
                        <h6>Aktu√°ln√≠ operace:</h6>
                        <div id="currentOperation" class="alert alert-info">
                            <i class="bi bi-hourglass-split me-2"></i>
                            <span id="operationText">ƒåek√°m na spu≈°tƒõn√≠...</span>
                        </div>
                    </div>
                    
                    {* Kontroln√≠ tlaƒç√≠tka *}
                    <div class="text-center mt-4">
                        <button id="pauseEncryptionBtn" class="btn btn-warning me-2" style="display: none;">
                            <i class="bi bi-pause-fill me-2"></i>Pozastavit
                        </button>
                        <button id="stopEncryptionBtn" class="btn btn-danger" style="display: none;">
                            <i class="bi bi-stop-fill me-2"></i>Zastavit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{* V√Ωsledky - zobraz√≠ se po dokonƒçen√≠ *}
<div id="encryptionResults" class="security-tools-section" style="display: none;">
    <h2 class="security-tools-title">V√Ωsledky ≈°ifrov√°n√≠</h2>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i id="resultIcon" class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h4 id="resultTitle">≈†ifrov√°n√≠ dokonƒçeno √∫spƒõ≈°nƒõ!</h4>
                    <p id="resultDescription" class="text-muted">V≈°echna citliv√° data byla bezpeƒçnƒõ za≈°ifrov√°na.</p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <div class="h4 mb-1" id="resultProcessed">0</div>
                                <small class="text-muted">Za≈°ifrov√°no z√°znam≈Ø</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <div class="h4 mb-1" id="resultDuration">0s</div>
                                <small class="text-muted">Doba trv√°n√≠</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <a href="{link default}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-2"></i>Zpƒõt na p≈ôehled
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{* JavaScript pro ≈ô√≠zen√≠ procesu *}
<script n:syntax=off>
document.addEventListener('DOMContentLoaded', function() {
    let encryptionInProgress = false;
    let encryptionStartTime = null;
    
    // Spu≈°tƒõn√≠ anal√Ωzy dat
    const analyzeBtn = document.getElementById('analyzeDataBtn');
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function() {
            analyzeData();
        });
    }
    
    // Spu≈°tƒõn√≠ ≈°ifrov√°n√≠
    const startBtn = document.getElementById('startEncryptionBtn');
    if (startBtn) {
        startBtn.addEventListener('click', function() {
            startEncryption();
        });
    }
    
    // Automatick√° anal√Ωza p≈ôi naƒçten√≠ str√°nky
    setTimeout(() => {
        analyzeData();
    }, 500);
    
    // Anal√Ωza dat
    function analyzeData() {
        const btn = document.getElementById('analyzeDataBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Analyzuje se...';
        
        fetch(btn.dataset.url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data['success']) {
                updateAnalysisResults(data['data']);
                
                // Zobraz tlaƒç√≠tko pro start pokud jsou data k ≈°ifrov√°n√≠
                if (data['data']['clients_to_encrypt'] > 0 || data['data']['companies_to_encrypt'] > 0) {
                    document.getElementById('startEncryptionBtn').style.display = 'inline-block';
                }
            } else {
                showError('Chyba p≈ôi anal√Ωze: ' + data['message']);
            }
        })
        .catch(error => {
            showError('Chyba p≈ôi anal√Ωze dat');
            console.error('Error:', error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search me-2"></i>Spustit anal√Ωzu';
        });
    }
    
    // Aktualizace v√Ωsledk≈Ø anal√Ωzy
    function updateAnalysisResults(data) {
    document.getElementById('clientsToEncrypt').textContent = data['clients_to_encrypt'];
    document.getElementById('companiesToEncrypt').textContent = data['companies_to_encrypt'];
    
    const status = document.getElementById('encryptionStatus');
    const statusCard = status.closest('.security-stat-card');
    const statusIcon = status.parentElement.querySelector('.security-stat-icon i');
    
    if (data['clients_to_encrypt'] === 0 && data['companies_to_encrypt'] === 0) {
        // ‚úÖ V≈°e za≈°ifrov√°no - pƒõkn√Ω zelen√Ω design
        status.textContent = 'V≈°e za≈°ifrov√°no';
        status.style.color = '#B1D235';
        status.style.fontWeight = 'bold';
        
        // Zmƒõna ikony na √∫spƒõ≈°nou
        statusIcon.className = 'bi bi-shield-check';
        statusIcon.style.color = '#B1D235';
        
        // P≈ôid√°n√≠ jemn√©ho zelen√©ho efektu na celou kartu
        statusCard.style.borderLeft = '4px solid #B1D235';
        statusCard.style.backgroundColor = 'rgba(177, 210, 53, 0.05)';
        
        console.log('‚úÖ Status nastaven na: V≈°e za≈°ifrov√°no (zelen√Ω)');
    } else {
        // ‚ö†Ô∏è Vy≈æaduje ≈°ifrov√°n√≠ - norm√°ln√≠ design
        status.textContent = 'Vy≈æaduje ≈°ifrov√°n√≠';
        status.style.color = '#6c757d';
        status.style.fontWeight = 'normal';
        
        // Zmƒõna ikony na varov√°n√≠
        statusIcon.className = 'bi bi-shield-exclamation';
        statusIcon.style.color = '#ffc107';
        
        // Odstranƒõn√≠ zelen√©ho efektu
        statusCard.style.borderLeft = '';
        statusCard.style.backgroundColor = '';
        
        console.log('‚ö†Ô∏è Status nastaven na: Vy≈æaduje ≈°ifrov√°n√≠');
    }
}
    
    // Spu≈°tƒõn√≠ ≈°ifrov√°n√≠
    function startEncryption() {
        if (encryptionInProgress) return;
        
        encryptionInProgress = true;
        encryptionStartTime = Date.now();
        
        // Skryt√≠ anal√Ωzy a zobrazen√≠ progress
        document.getElementById('dataAnalysis').style.display = 'none';
        document.getElementById('encryptionProgress').style.display = 'block';
        
        // Start ≈°ifrov√°n√≠
        runEncryptionBatch();
    }
    
    // Spu≈°tƒõn√≠ batch operace
    function runEncryptionBatch() {
        const startBtn = document.getElementById('startEncryptionBtn');
        
        fetch(startBtn.dataset.url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data['success']) {
                updateProgress(data['data']);
                
                if (data['data']['completed']) {
                    showResults(data['data']);
                } else {
                    // Pokraƒçov√°n√≠ v dal≈°√≠m batch
                    setTimeout(() => {
                        if (encryptionInProgress) {
                            runEncryptionBatch();
                        }
                    }, 500);
                }
            } else {
                showError('Chyba p≈ôi ≈°ifrov√°n√≠: ' + data['message']);
                encryptionInProgress = false;
            }
        })
        .catch(error => {
            showError('Chyba p≈ôi ≈°ifrov√°n√≠ dat');
            console.error('Error:', error);
            encryptionInProgress = false;
        });
    }
    
    // Aktualizace progress baru - s kontrolou existence element≈Ø
    function updateProgress(data) {
        console.log('üìä Aktualizuji progress:', data);
        
        // Kontrola dat
        if (!data || typeof data !== 'object') {
            console.error('‚ùå Neplatn√° data pro progress:', data);
            return;
        }
        
        const processed = data['processed'] || 0;
        const total = data['total'] || 0;
        const percentage = total > 0 ? Math.round((processed / total) * 100) : 0;
        
        console.log(`üìà Progress kalkulace: ${processed}/${total} = ${percentage}%`);
        
        // Bezpeƒçn√° aktualizace element≈Ø s kontrolou existence
        const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                console.log(`‚úÖ Element ${id} aktualizov√°n na: ${value}`);
            } else {
                console.error(`‚ùå Element ${id} nenalezen!`);
            }
        };
        
        const updateElementStyle = (id, property, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.style[property] = value;
                console.log(`‚úÖ Element ${id} style ${property} nastaven na: ${value}`);
            } else {
                console.error(`‚ùå Element ${id} nenalezen pro style update!`);
            }
        };
        
        // Aktualizace progress baru
        updateElement('progressPercentage', percentage + '%');
        updateElementStyle('progressBar', 'width', percentage + '%');
        
        // Aktualizace statistik
        updateElement('processedCount', processed);
        updateElement('totalCount', total);
        updateElement('currentBatch', data['current_batch'] || 0);
        updateElement('errorsCount', data['errors'] || 0);
        updateElement('operationText', data['current_operation'] || 'Zpracov√°v√°m data...');
        
        console.log('‚úÖ Progress aktualizace dokonƒçena');
    }
    
    // Zobrazen√≠ v√Ωsledk≈Ø
    function showResults(data) {
        encryptionInProgress = false;
        
        document.getElementById('encryptionProgress').style.display = 'none';
        document.getElementById('encryptionResults').style.display = 'block';
        
        document.getElementById('resultProcessed').textContent = data['processed'];
        
        const duration = Math.round((Date.now() - encryptionStartTime) / 1000);
        document.getElementById('resultDuration').textContent = duration + 's';
        
        if (data['errors'] > 0) {
            document.getElementById('resultIcon').className = 'bi bi-exclamation-triangle-fill text-warning';
            document.getElementById('resultTitle').textContent = '≈†ifrov√°n√≠ dokonƒçeno s upozornƒõn√≠mi';
            document.getElementById('resultDescription').textContent = 'Zpracov√°no ' + data['processed'] + ' z√°znam≈Ø, ' + data['errors'] + ' chyb.';
        }
    }
    
    // Zobrazen√≠ chyby
    function showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible';
        alert.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>' + 
            message + 
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        
        const container = document.querySelector('.container');
        container.insertBefore(alert, container.firstChild);
    }
});
</script>

{/block}