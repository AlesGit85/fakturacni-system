{* Rate Limiting Statistiky - Konzistentn√≠ design *}
{block title}Rate Limiting Statistiky{/block}

{block content}

{* Hlaviƒçka str√°nky - stejn√Ω styl jako ostatn√≠ str√°nky *}
<div class="security-page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>üìä Rate Limiting Statistiky</h1>
            <p>Monitoring a spr√°va rate limiting syst√©mu</p>
        </div>
        <div class="security-header-actions">
            <a href="{link Security:dashboard}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left me-2"></i>Zpƒõt na Dashboard
            </a>
            <button id="clearExpiredBtn" class="btn security-tool-btn btn-warning">
                <i class="bi bi-trash me-2"></i>Vyƒçistit expirovan√©
            </button>
        </div>
    </div>
</div>

{* Statistiky p≈ôehled - konzistentn√≠ karty *}
<div class="security-tools-section">
    <h2 class="security-tools-title">P≈ôehled statistik</h2>
    
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card security-stat-card rate-limit-stat">
                <div class="card-body">
                    <div class="security-stat-icon danger">
                        <i class="bi bi-ban"></i>
                    </div>
                    <div class="security-stat-number text-danger">{$statistics['currently_blocked_ips'] ?? 0}</div>
                    <div class="security-stat-label">Aktu√°lnƒõ blokovan√©</div>
                    <div class="security-stat-subtitle">IP adres</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card security-stat-card rate-limit-stat">
                <div class="card-body">
                    <div class="security-stat-icon info">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="security-stat-number text-info">{$statistics['attempts_last_24h'] ?? 0}</div>
                    <div class="security-stat-label">Pokusy za 24h</div>
                    <div class="security-stat-subtitle">Celkem</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card security-stat-card rate-limit-stat">
                <div class="card-body">
                    <div class="security-stat-icon warning">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="security-stat-number text-warning">{$statistics['failed_attempts_last_24h'] ?? 0}</div>
                    <div class="security-stat-label">Ne√∫spƒõ≈°n√© pokusy</div>
                    <div class="security-stat-subtitle">Za 24h</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card security-stat-card rate-limit-stat">
                <div class="card-body">
                    <div class="security-stat-icon success">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="security-stat-number text-success">{$statistics['success_rate'] ?? 0}%</div>
                    <div class="security-stat-label">√öspƒõ≈°nost</div>
                    <div class="security-stat-subtitle">Rate</div>
                </div>
            </div>
        </div>
    </div>
</div>

{* Aktu√°lnƒõ blokovan√© IP adresy *}
<div class="security-tools-section">
    <h2 class="security-tools-title">Aktu√°lnƒõ blokovan√© IP adresy</h2>
    
    {if count($blockedIPs) > 0}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card security-events-card blocked-ips">
                <div class="security-events-header">
                    <h5>
                        <i class="bi bi-ban me-2"></i>Aktu√°lnƒõ blokovan√© IP adresy
                    </h5>
                    <span class="badge bg-danger">{count($blockedIPs)} aktivn√≠ch</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table security-events-table mb-0">
                            <thead>
                                <tr>
                                    <th>IP Adresa</th>
                                    <th>Akce</th>
                                    <th>Blokov√°no do</th>
                                    <th>Poƒçet blokov√°n√≠</th>
                                    <th>Vytvo≈ôeno</th>
                                    <th>Akce</th>
                                </tr>
                            </thead>
                            <tbody>
                                {foreach $blockedIPs as $block}
                                <tr>
                                    <td>
                                        <code class="security-event-ip danger">{$block->ip_address}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary security-event-badge">{$block->action}</span>
                                    </td>
                                    <td>
                                        <span class="security-event-time">{$block->blocked_until|date:'d.m.Y H:i:s'}</span>
                                        <div class="security-event-status">
                                            {if $block->blocked_until > (new DateTime())}
                                                <span class="badge bg-danger">Aktivn√≠</span>
                                            {else}
                                                <span class="badge bg-success">Expirovan√©</span>
                                            {/if}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning text-dark">{$block->block_count}x</span>
                                    </td>
                                    <td>
                                        <span class="security-event-time">{$block->created_at|date:'d.m.Y H:i'}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-success clear-block-btn" 
                                                data-ip="{$block->ip_address}" 
                                                title="Odblokovat tuto IP">
                                            <i class="bi bi-unlock"></i>
                                        </button>
                                    </td>
                                </tr>
                                {/foreach}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {else}
    <div class="row mb-4">
        <div class="col-12">
            <div class="security-empty-state success">
                <i class="bi bi-check-circle"></i>
                <h5>≈Ω√°dn√© aktivn√≠ blokov√°n√≠</h5>
                <p>V tuto chv√≠li nejsou blokov√°ny ≈æ√°dn√© IP adresy.</p>
            </div>
        </div>
    </div>
    {/if}
</div>

{* Nejƒçastƒõj≈°√≠ typy blokov√°n√≠ *}
{if count($blockTypes) > 0}
<div class="security-tools-section">
    <h2 class="security-tools-title">Nejƒçastƒõj≈°√≠ typy blokov√°n√≠</h2>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card security-issues-card block-types">
                <div class="security-issues-header">
                    <h5>
                        <i class="bi bi-bar-chart me-2"></i>Nejƒçastƒõj≈°√≠ typy blokov√°n√≠ (7 dn√≠)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {foreach $blockTypes as $type}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="rate-limit-block-type">
                                <div class="rate-limit-block-type-content">
                                    <div class="rate-limit-block-type-label">{$type->action}</div>
                                    <div class="rate-limit-block-type-subtitle">Typ akce</div>
                                </div>
                                <div class="rate-limit-block-type-number">
                                    <div class="rate-limit-block-type-count">{$type->count}</div>
                                    <div class="rate-limit-block-type-unit">blokov√°n√≠</div>
                                </div>
                            </div>
                        </div>
                        {/foreach}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{/if}

{* TOP IP adresy s nejv√≠ce pokusy *}
{if isset($statistics['top_attacking_ips']) && count($statistics['top_attacking_ips']) > 0}
<div class="security-tools-section">
    <h2 class="security-tools-title">TOP √∫toƒç√≠c√≠ IP adresy</h2>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card security-issues-card top-attackers">
                <div class="security-issues-header">
                    <h5>
                        <i class="bi bi-shield-exclamation me-2"></i>TOP IP adresy s nejv√≠ce ne√∫spƒõ≈°n√Ωmi pokusy
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table security-events-table">
                            <thead>
                                <tr>
                                    <th>IP Adresa</th>
                                    <th>Poƒçet pokus≈Ø</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {foreach $statistics['top_attacking_ips'] as $topIP}
                                <tr>
                                    <td><code class="security-event-ip">{$topIP->ip_address}</code></td>
                                    <td><span class="badge bg-danger">{$topIP->attempt_count}</span></td>
                                    <td>
                                        <span class="badge bg-secondary">Monitorov√°no</span>
                                    </td>
                                </tr>
                                {/foreach}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{/if}

{* Informaƒçn√≠ panel *}
<div class="security-tools-section">
    <h2 class="security-tools-title">Konfigurace rate limiting</h2>
    
    <div class="row">
        <div class="col-12">
            <div class="card security-recommendations-card">
                <div class="security-recommendations-header">
                    <h5>
                        <i class="bi bi-info-circle-fill me-2"></i>Informace o Rate Limiting
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="security-recommendation-section">
                                <h6 class="security-recommendation-title">
                                    <i class="bi bi-gear me-2"></i>Nastaven√≠:
                                </h6>
                                <ul class="security-recommendation-list">
                                    <li><strong>Login:</strong> max 5 pokus≈Ø za 15 minut</li>
                                    <li><strong>Password reset:</strong> max 3 pokusy za 30 minut</li>
                                    <li><strong>ARES lookup:</strong> max 10 pokus≈Ø za 5 minut</li>
                                    <li><strong>API calls:</strong> max 100 pokus≈Ø za hodinu</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="security-recommendation-section">
                                <h6 class="security-recommendation-title">
                                    <i class="bi bi-clock me-2"></i>D√©lka blokov√°n√≠:
                                </h6>
                                <ul class="security-recommendation-list">
                                    <li><strong>Login:</strong> 30 minut</li>
                                    <li><strong>Password reset:</strong> 60 minut</li>
                                    <li><strong>ARES lookup:</strong> 10 minut</li>
                                    <li><strong>API calls:</strong> 120 minut</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="security-intro-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Pozor:</strong> Vyƒçi≈°tƒõn√≠ rate limit≈Ø by mƒõlo b√Ωt pou≈æ√≠v√°no pouze v p≈ô√≠padƒõ pot≈ôeby. 
                        Automatick√© ƒçi≈°tƒõn√≠ expirovan√Ωch z√°znam≈Ø prob√≠h√° pravidelnƒõ.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{* AJAX Loading indik√°tor *}
<div id="loadingIndicator" class="security-loading-section" style="display: none;">
    <div class="security-loading">
        <div class="spinner-border security-spinner" role="status">
            <span class="visually-hidden">Zpracov√°n√≠...</span>
        </div>
        <div class="security-loading-content">
            <h5>Zpracov√°n√≠...</h5>
            <p>ƒåist√≠m rate limit z√°znamy...</p>
        </div>
    </div>
</div>

{* JavaScript include *}
<script src="{$basePath}/js/security-rate-limit-stats.js"></script>

{/block}